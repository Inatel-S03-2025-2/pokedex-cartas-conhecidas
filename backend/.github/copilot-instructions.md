# Pokédex Cards Backend - AI Agent Instructions

## Architecture Overview
This is a TypeScript Express backend implementing SOA (Service-Oriented Architecture) for a Pokédex card tracking system. The app tracks which cards users have "discovered" without storing full card data locally.

## Key Architectural Patterns

### Dual Token System
- **External tokens**: From `AuthAPI` service for user authentication
- **Internal tokens**: Generated by `JWTService` for session management in this backend
- Pattern: External auth → internal user creation → internal JWT generation
- See `UserController.login()` and `JTWService.generateToken()`

### Database Strategy
- Uses **Prisma** with SQLite for local data
- Stores minimal data: Users and Card associations only
- No card details stored (fetched from PokeAPI as needed)
- Cards reference `cardId` (external PokeAPI ID) not internal database IDs

### Repository Pattern Implementation
- All data access through repository interfaces (`ICardRepository`, `IUserRepository`)
- Concrete implementations: `PrismaCardRepository`, `PrismaUserRepository`
- Dependency injection via `repositories/index.ts`

## Development Workflows

### Essential Commands
```bash
# Development (auto-restart)
npm run dev

# Database operations
npm run prisma:generate  # After schema changes
npm run prisma:migrate   # Create/apply migrations
npm run prisma:studio    # Visual database browser

# Production build
npm run build && npm start
```

### Mock Service Dependencies
- Run `node scripts/auth-api-mock.js` on port 4000 for local development
- Mock users: `user@test.com:senha123`, `user2@test.com:senha123`
- Set `AUTENTICATION_SERVICE=localhost:4000` in `.env`

## Critical Conventions

### Environment Variables (Required)
```
PORT=3001
JWT_SECRET=your-secret
NODE_ENV=development
DATABASE_URL="file:./dev.db"
AUTENTICATION_SERVICE=localhost:4000
```

### Response Factory Pattern
All API responses use the `ApiResponse` utility class from `utils/ApiResponse.ts`:
```typescript
// Success responses
ApiResponse.success(res, 'Operation successful', data);

// Error responses 
ApiResponse.badRequest(res, 'Invalid input');
ApiResponse.unauthorized(res, 'Token required');
ApiResponse.notFound(res, 'Resource not found');
ApiResponse.internalError(res);
```
- **Static Factory Methods**: Each method creates a specific type of standardized response
- **Utility Pattern**: Centralized helper for common HTTP response creation
- **Consistent Format**: `{success: boolean, message: string, data?: any}`
- **Semantic Methods**: Clear intent with proper HTTP status codes

### Middleware Chain Pattern
Routes use: `authMiddleware` → `roleMiddleware` (if needed) → controller
- `AuthRequest` interface extends Express Request with user data
- User data attached to `req.user` after token verification

### Card ID Mapping
- **Database `cardId`**: External PokeAPI card identifier
- **Database `id`**: Internal auto-increment (rarely used)
- **API responses**: Always use `cardId` for external references

## Service Integration Points

### AuthAPI Communication
- POST to `/login` with email/password
- Expects `{user: {userId, email, role}, token}` response
- Token stored as `externalToken` in User model

## Database Relationships
```typescript
// User can have many Cards (many-to-many with Pokemon cards)
User.cards → Card[]
Card.user → User (optional, cascade delete)

// Unique constraint prevents duplicate card tracking
@@unique([userId, cardId]) in Card model
```

## Testing Strategy
- Use mock AuthAPI service for integration tests
- Prisma supports in-memory SQLite for unit tests
- Test external API failures (AuthAPI/PokeAPI unavailable)

## Common Pitfalls
- Don't confuse internal `User.userId` with external auth service user IDs
- Always verify tokens exist in database, not just JWT validity
- Card operations work with users who haven't logged into this service yet
- External API calls can fail - handle gracefully with null returns

## File Structure Significance
- `controllers/`: Express route handlers only
- `services/`: Business logic, external API calls
- `repositories/`: Data access abstraction with entity interfaces (`I*Repository.ts`)
- `middlewares/`: Request preprocessing (auth, validation)
- `external/`: Third-party service integrations
- `interfaces/`: Shared DTOs and request/response interfaces
- `utils/`: Utility classes (ApiResponse, etc.)

## Interface Organization Strategy
- **Repository interfaces**: Stay with repositories (`IUserRepository`, `IUser`)
- **DTOs & Request/Response**: Centralized in `/interfaces/` by domain
- **Import pattern**: `import { ILoginRequest } from '../interfaces'`
- **Domain separation**: `auth.interfaces.ts`, `card.interfaces.ts`
- `utils/`: Shared utilities